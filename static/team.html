<html>
<head>
  <title>Team Mood Panel</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name='description' content='Listen to your team. Optimize for happiness.'>
  <meta name='keywords' content='team, happiness, emotion, retrospective, mood'>
  <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
  <script src="scripts/jquery-3.3.1.min.js"></script>
  <style>
    body {
      font-family: Verdana, Geneva, Tahoma, sans-serif
    }

    #canvas {
      max-width: 700px;
      margin: auto;
      position: relative;
    }

    #roulette, #heatmap {
      display: block;
      width: 700px;
      position: absolute;
    }

    img.point {
      display: block;
      position: absolute;
    }

    img.point:not(.mine) {
      filter: grayscale(50%);
    }

    img.mine {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <center>
    <h1>
      Mood <u><span id="teamname"></span></u> (beta)
      <i class="fa fa-question-circle-o" style="color: gray; cursor: pointer" title="Team members can anonymously mark how they feel. Old marks slowly vanish until they disappear after 7 days."></i>
    </h1>

  </center>
  <div id='canvas'>
    <img id='roulette' src='roulette.jpg'>
  </div>

  <script>
  const BACKEND_BASE = 'https://13ssj562ne.execute-api.eu-west-1.amazonaws.com/dev';
  const POINT_DIAMETER = 12;
  const DEFAULT_TEAM_ID = 'global';

  function getQueryParameters() {
    const vars = {};
    const href = window.location.href;
    if (href.indexOf('?') > 0) {
      const params = href.slice(href.indexOf('?') + 1).split('&');
      params.forEach(param => {
        const kv = param.split('=');
        vars[kv[0]] = param.slice(param.indexOf('=') + 1);
      });
    }
    return vars;
  };

  function drawPoint(team, x, y, timestamp, pid = null) {
    const point = $(('<img>')).attr('src', 'point.png')
                              .addClass('point')
                              .css('width', POINT_DIAMETER + 'px')
                              .css('left', x - POINT_DIAMETER / 2)
                              .css('top', y - POINT_DIAMETER / 2);

    const timeDiff = Date.now() - timestamp;
    const opacity = 1 - 0.025 * timeDiff / (6 * 60 * 60 * 1000);  // substract 0.025 each 6h
    point.css('opacity', opacity > 0.1 ? opacity : 0.1);

    if (pid) {
      point.data('pid', pid).addClass('mine');

      point.on('click', (e) => {
        $.ajax({url: BACKEND_BASE + '/' + team + '/points/' + pid, type: 'DELETE'})
          .done(res => $(e.target).remove())
          .fail(err => alert('Error removing mood point'));
      });
    }

    $('#canvas').append(point);
  }

  function loadPoints(team) {
    $.get(BACKEND_BASE + '/' + team + '/points')
      .done(points => points.forEach(point => drawPoint(team, point.x, point.y, point.timestamp)))
      .fail(err => alert('Error loading your team\'s mood'));
  }

  $(document).ready(() => {
    const team = getQueryParameters().team || DEFAULT_TEAM_ID;
    $("#teamname").text(team);

    loadPoints(team);

    const roulette = document.getElementById('roulette');

    $(roulette).on('click', (e) => {
      const bounds = e.target.getBoundingClientRect();

      const x = Math.round(e.clientX - bounds.left);
      const y = Math.round(e.clientY - bounds.top);

      const point = { x, y };

      $.ajax({
        url: BACKEND_BASE + '/' + team + '/points',
        type: 'POST',
        data: JSON.stringify(point),
        dataType: 'json'
      })
      .done(result => drawPoint(team, x, y, Date.now(), result.pid))
      .fail(err => alert('Error saving your mood'));
    });
  });
  </script>
</body>
</html>
